<TrustFrameworkPolicy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06" PolicySchemaVersion="0.3.0.0" TenantId="{TenantID}" PolicyId="B2C_1A_signup_signin_rest_api_idp" PublicPolicyUri="http://{TenantID}/B2C_1A_signup_signin_rest_api_idp" TenantObjectId="{TenantObjectID}">
	<BasePolicy>
		<TenantId>{TenantID}</TenantId>
		<PolicyId>B2C_1A_TrustFrameworkExtensions</PolicyId>
	</BasePolicy>
	<BuildingBlocks>
		<ClaimsTransformations>
			<ClaimsTransformation Id="CreateAlternativeSecurityId-With-SignInName" TransformationMethod="CreateAlternativeSecurityId">
				<InputClaims>
					<InputClaim ClaimTypeReferenceId="signInName" TransformationClaimType="key"/>
					<InputClaim ClaimTypeReferenceId="identityProvider" TransformationClaimType="identityProvider"/>
				</InputClaims>
				<OutputClaims>
					<OutputClaim ClaimTypeReferenceId="alternativeSecurityId" TransformationClaimType="alternativeSecurityId"/>
				</OutputClaims>
			</ClaimsTransformation>
		</ClaimsTransformations>
	</BuildingBlocks>
	<ClaimsProviders>
		<ClaimsProvider>
			<DisplayName>Local Account</DisplayName>
			<TechnicalProfiles>
				<TechnicalProfile Id="SelfAsserted-RestAPISignin-Email">
					<DisplayName>Local Account Signin</DisplayName>
					<Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"/>
					<Metadata>
						<!--Sample: disable the sign-up -->
						<Item Key="setting.showSignupLink">false</Item>
						<Item Key="SignUpTarget">SignUpWithLogonEmailExchange</Item>
						<Item Key="setting.operatingMode">Username</Item>
						<Item Key="ContentDefinitionReferenceId">api.selfasserted</Item>
					</Metadata>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="signInName"/>
					</InputClaims>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="signInName" Required="true"/>
						<OutputClaim ClaimTypeReferenceId="password" Required="true"/>
						<OutputClaim ClaimTypeReferenceId="authenticationSource" DefaultValue="socialIdpAuthentication" AlwaysUseDefaultValue="true"/>
						<OutputClaim ClaimTypeReferenceId="identityProvider" DefaultValue="rest-api" AlwaysUseDefaultValue="true"/>
						<OutputClaim ClaimTypeReferenceId="displayName" PartnerClaimType="signInName"/>
					</OutputClaims>
					<OutputClaimsTransformations>
						<OutputClaimsTransformation ReferenceId="CreateRandomUPNUserName"/>
						<OutputClaimsTransformation ReferenceId="CreateUserPrincipalName"/>
						<OutputClaimsTransformation ReferenceId="CreateAlternativeSecurityId-With-SignInName"/>
					</OutputClaimsTransformations>
					<ValidationTechnicalProfiles>
						<ValidationTechnicalProfile ReferenceId="REST-Login"/>
					</ValidationTechnicalProfiles>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-NOOP"/>
				</TechnicalProfile>
			</TechnicalProfiles>
		</ClaimsProvider>
		<ClaimsProvider>
			<DisplayName>Custom REST API</DisplayName>
			<TechnicalProfiles>
				<TechnicalProfile Id="REST-Login">
					<DisplayName>Validate user input data and return loyaltyNumber claim</DisplayName>
					<Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"/>
					<Metadata>
						<Item Key="ServiceUrl">https://{REST API URL}</Item>
						<Item Key="AuthenticationType">None</Item>
						<Item Key="SendClaimsIn">Body</Item>
						<Item Key="AllowInsecureAuthInProduction">True</Item>
					</Metadata>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="signInName" PartnerClaimType="username"/>
						<InputClaim ClaimTypeReferenceId="password"/>
					</InputClaims>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop"/>
				</TechnicalProfile>
			</TechnicalProfiles>
		</ClaimsProvider>
	</ClaimsProviders>
	<UserJourneys>
		<UserJourney Id="SignUpOrSignInWithRestApiIDP">
			<OrchestrationSteps>
				<OrchestrationStep Order="1" Type="CombinedSignInAndSignUp" ContentDefinitionReferenceId="api.signuporsignin">
					<ClaimsProviderSelections>
						<!--<ClaimsProviderSelection TargetClaimsExchangeId="FacebookExchange"/>-->
						<ClaimsProviderSelection ValidationClaimsExchangeId="LocalAccountSigninEmailExchange"/>
					</ClaimsProviderSelections>
					<ClaimsExchanges>
						<!--Sample: show the sign-in page with the REST API IDP-->
						<ClaimsExchange Id="LocalAccountSigninEmailExchange" TechnicalProfileReferenceId="SelfAsserted-RestAPISignin-Email"/>
					</ClaimsExchanges>
				</OrchestrationStep>
				<!-- For social IDP authentication, attempt to find the user account in the directory. -->
				<OrchestrationStep Order="2" Type="ClaimsExchange">
					<Preconditions>
						<Precondition Type="ClaimEquals" ExecuteActionsIf="true">
							<Value>authenticationSource</Value>
							<Value>localAccountAuthentication</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
					</Preconditions>
					<ClaimsExchanges>
						<ClaimsExchange Id="AADUserReadUsingAlternativeSecurityId" TechnicalProfileReferenceId="AAD-UserReadUsingAlternativeSecurityId-NoError"/>
					</ClaimsExchanges>
				</OrchestrationStep>
				<OrchestrationStep Order="3" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer"/>
			</OrchestrationSteps>
			<ClientDefinition ReferenceId="DefaultWeb"/>
		</UserJourney>
	</UserJourneys>
	<RelyingParty>
		<DefaultUserJourney ReferenceId="SignUpOrSignInWithRestApiIDP"/>
		<TechnicalProfile Id="PolicyProfile">
			<DisplayName>PolicyProfile</DisplayName>
			<Protocol Name="OpenIdConnect"/>
			<OutputClaims>
				<OutputClaim ClaimTypeReferenceId="displayName"/>
				<OutputClaim ClaimTypeReferenceId="givenName"/>
				<OutputClaim ClaimTypeReferenceId="surname"/>
				<OutputClaim ClaimTypeReferenceId="objectId"/>
				<OutputClaim ClaimTypeReferenceId="signInName" PartnerClaimType="sub"/>
				<OutputClaim ClaimTypeReferenceId="identityProvider"/>
				<OutputClaim ClaimTypeReferenceId="tenantId" AlwaysUseDefaultValue="true" DefaultValue="{Policy:TenantObjectId}"/>
			</OutputClaims>
			<SubjectNamingInfo ClaimType="sub"/>
		</TechnicalProfile>
	</RelyingParty>
</TrustFrameworkPolicy>